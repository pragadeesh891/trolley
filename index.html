<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.2" />
  <title>AI-Powered Shopping Trolley</title>
  <meta name="description" content="Connect to an AI-powered smart trolley, shop, and checkout." />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg: #0b1020;
      --panel: #12172a;
      --panel-2:#0f1426;
      --text: #eef2ff;
      --muted: #9aa3b2;
      --brand: #6e9bff;
      --brand-2:#7af7d5;
      --ok:#47d18c;
      --bad:#ff6470;
      --warn:#ffd466;
      --radius: 18px;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: radial-gradient(1200px 600px at 80% -10%, rgba(110,155,255,.25), transparent 60%),
                  radial-gradient(800px 400px at -10% 10%, rgba(122,247,213,.15), transparent 50%),
                  var(--bg);
      color:var(--text);
    }
    a{color:var(--brand)}
    .container{max-width:1200px; margin:0 auto; padding:24px}
    header{
      position:sticky; top:0; z-index:10; backdrop-filter: blur(8px);
      background: rgba(11,16,32,.6); border-bottom:1px solid rgba(255,255,255,.06);
    }
    .nav{display:flex; align-items:center; justify-content:space-between; gap:16px}
    .logo{display:flex; align-items:center; gap:20px; font-weight:800; letter-spacing:.3px}
    .logo-badge{width:36px; height:36px; border-radius:12px; background: linear-gradient(135deg, var(--brand), var(--brand-2)); display:grid; place-items:center; box-shadow:var(--shadow)}
    .logo-badge svg{filter: drop-shadow(0 4px 10px rgba(110,155,255,.6))}
    .nav .actions{display:flex; gap:10px; align-items:center}
    .btn{appearance:none; border:0; padding:10px 14px; border-radius:14px; font-weight:600; cursor:pointer; transition:.2s transform, .2s filter, .2s background;
      background:linear-gradient(180deg,#1a2140,#131a34); color:var(--text); border:1px solid rgba(255,255,255,.06)}
    .btn:hover{transform: translateY(-1px)}
    .btn.primary{background: linear-gradient(135deg, var(--brand), var(--brand-2)); color:#0b1020}
    .grid{display:grid; gap:16px}
    @media(min-width:900px){
      .grid.cols-3{grid-template-columns:1.2fr 1fr 1fr}
      .grid.cols-2{grid-template-columns:1fr 1.3fr}
    }
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.01));
      border:1px solid rgba(255,255,255,.06); border-radius: var(--radius); padding:18px; box-shadow: var(--shadow);
    }
    .hero{padding:32px 0 18px}
    .hero h1{margin:0 0 8px; font-size: clamp(30px, 5vw, 45px); line-height:1.1}
    .hero p{margin:0; color:var(--muted)}
    .badges{display:flex; gap:8px; flex-wrap:wrap; margin-top:14px}
    .badge{font-size:12px; padding:6px 20px; border-radius:999px; border:1px solid rgba(255,255,255,.12); color:var(--muted); background: rgba(255,255,255,.03)}

    .pair-box{display:grid; gap:12px}
    .pair-status{display:flex; align-items:center; gap:10px; font-weight:600}
    .dot{width:20px; height:20px; border-radius:999px; background:var(--bad); box-shadow: 0 0 0 3px rgba(255,100,112,.15)}
    .dot.ok{background:var(--ok); box-shadow: 0 0 0 3px rgba(71,209,140,.15)}

    .row{display:flex; gap:10px; flex-wrap:wrap}
    .row input[type="text"]{flex:1; min-width:180px; padding:12px 14px; border-radius:12px; background:#0f1426; border:1px solid rgba(255,255,255,.08); color:var(--text)}

    .qr{display:grid; grid-template-columns:120px 1fr; gap:14px; align-items:center}
    .qr .box{width:120px; height:120px; border-radius:14px; background:repeating-linear-gradient(45deg, #182040, #182040 8px, #151c38 8px, #151c38 16px); display:grid; place-items:center; position:relative}
    .qr .box::after{content:"QR"; font-weight:800; font-size:20px; color:rgba(255,255,255,.2)}

    .list{display:flex; gap:8px; flex-wrap:wrap}
    .chip{padding:8px 10px; background:#0f1426; border:1px solid rgba(255,255,255,.06); border-radius:12px; font-size:13px; color:var(--muted)}

    .title{font-weight:700; margin:0 0 10px}
    .subtitle{color:var(--muted); margin:4px 0 14px}

    .items{display:flex; gap:10px; flex-direction:column; max-height:340px; overflow:auto}
    .item{display:grid; grid-template-columns:42px 1fr auto; gap:10px; align-items:center; padding:10px; border-radius:12px; background:#0f1426; border:1px solid rgba(255,255,255,.06)}
    .item .img{width:42px; height:42px; border-radius:10px; background:linear-gradient(135deg,#263162,#1b234a)}
    .price{font-weight:700}
    .muted{color:var(--muted)}

    .status{display:grid; grid-template-columns:1fr 1fr; gap:10px}
    .stat{padding:12px; border-radius:14px; background:#0f1426; border:1px solid rgba(255,255,255,.06)}
    .stat h3{margin:0; font-size:14px; color:var(--muted)}
    .stat p{margin:8px 0 0; font-weight:800; font-size:22px}

    .pay-row{display:flex; justify-content:space-between; align-items:center}
    .total{font-size:20px; font-weight:800}

    footer{margin-top:26px; padding:30px 0 50px; color:var(--muted); text-align:center}
    .hint{font-size:20px; color:var(--muted)}
    .divider{height:3px; background: linear-gradient(90deg, transparent, rgba(255,255,255,.08), transparent); margin:10px 0 16px}

    /* Toast */
    .toast{position:fixed; right:20px; bottom:20px; background:#0f1426; border:1px solid rgba(255,255,255,.12); padding:12px 14px; border-radius:12px; box-shadow:var(--shadow); display:none}
    .toast.show{display:block; animation: slideup .25s ease-out}
    @keyframes slideup{from{transform:translateY(20px); opacity:0} to{transform:translateY(0); opacity:1}}

    .sr-only{position:absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); border:0}
    
    /* Language selector */
    .language-selector {
      margin: 10px 0;
      padding: 10px;
      border-radius: 12px;
      background: #0f1426;
      border: 1px solid rgba(255,255,255,.06);
      color: var(--text);
      width: 100%;
    }
    
    /* Assistant feed improvements */
    .ai-feed-item {
      padding: 12px;
      border-radius: 12px;
      background: rgba(110, 155, 255, 0.1);
      border: 1px solid rgba(110, 155, 255, 0.2);
      margin-bottom: 8px;
      word-wrap: break-word;
    }
    
    .ai-feed-item.user {
      background: rgba(122, 247, 213, 0.1);
      border: 1px solid rgba(122, 247, 213, 0.2);
    }
    
    .ai-feed-item.processing {
      background: rgba(255, 212, 102, 0.1);
      border: 1px solid rgba(255, 212, 102, 0.2);
      font-style: italic;
    }
    
    /* Payment Modal */
    #paymentModal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.7);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    
    #paymentModal .card {
      width: 90%;
      max-width: 400px;
      padding: 20px;
    }
    
    #paymentModal .title {
      text-align: center;
      margin-bottom: 10px;
    }
    
    #paymentModal .subtitle {
      text-align: center;
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 20px;
    }
    
    #paymentModal .btn {
      width: 100%;
      margin-bottom: 10px;
      padding: 15px;
      font-size: 16px;
      text-align: center;
    }
    
    #paymentModal .btn.primary {
      background: linear-gradient(135deg, var(--brand), var(--brand-2));
      color: #0b1020;
    }
    
    /* Camera Scanner */
    #cameraContainer {
      position: relative;
      width: 100%;
      height: 100%;
    }
    
    #qrVideo {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    #scanOverlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
    }
    
    #scanOverlay div {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 200px;
      height: 200px;
      border: 2px solid #6e9bff;
      box-shadow: 0 0 0 1000px rgba(0,0,0,0.5);
    }
    
    /* Payment QR Modal */
    #paymentQRModal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.7);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    
    #paymentQRModal .card {
      width: 90%;
      max-width: 400px;
      padding: 20px;
      text-align: center;
    }
    
    #paymentQRModal .title {
      text-align: center;
      margin-bottom: 10px;
    }
    
    #paymentQRModal .subtitle {
      text-align: center;
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 20px;
    }
    
    #paymentQRModal .btn {
      width: 100%;
      margin-top: 10px;
      padding: 15px;
      font-size: 16px;
      text-align: center;
    }
    
    #paymentQRModal .btn.primary {
      background: linear-gradient(135deg, var(--brand), var(--brand-2));
      color: #0b1020;
      margin-top: 20px;
    }
  </style>
</head>
<body>
<header>
  <div class="container nav">
    <div class="logo" aria-label="SmartCart Home">
      <div class="logo-badge" aria-hidden="true">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M3 5h2l2 10h10l2-6H7" stroke="#0b1020" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          <circle cx="10" cy="19" r="2" fill="#0b1020"/>
          <circle cx="17" cy="19" r="2" fill="#0b1020"/>
        </svg>
      </div>
      SmartCart
    </div>
    <div class="actions">
      <button class="btn" id="btnHelp">Help</button>
      <span style="font-weight:600; color:var(--muted); margin-left:10px;">Demo Mode</span>
      <button class="btn primary" id="btnDisconnect" disabled>Disconnect</button>
    </div>
  </div>
</header>

<main class="container">
  <section class="hero card">
    <h1>Connect to your AI‑Powered Trolley</h1>
    <p>Pair your phone, see live cart items, get aisle guidance, and checkout without queues.</p>
    <div class="badges">
      <span class="badge">🔒 Secure pairing</span>
      <span class="badge">🛰 Real‑time updates</span>
      <span class="badge">💳 One‑tap payment</span>
    </div>
  </section>

  <section class="grid cols-3">
    <div class="card">
      <h2 class="title">1) Pair with Trolley</h2>
      <p class="subtitle">Scan the QR on the trolley handle or enter the 6‑digit code.</p>

      <div class="pair-box">
        <div class="pair-status"><span id="pairDot" class="dot" aria-hidden="true"></span> <span id="pairText">Not connected</span></div>

        <div class="qr">
          <div class="box" role="img" aria-label="QR Code placeholder" id="qrCodeContainer">
            <div id="qrCodeDisplay" style="display: none;"></div>
            <div id="cameraContainer" style="display: none; position: relative;">
              <video id="qrVideo" style="width: 100%; height: 100%; object-fit: cover;"></video>
              <div id="scanOverlay" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none;">
                <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 200px; height: 200px; border: 2px solid #6e9bff; box-shadow: 0 0 0 1000px rgba(0,0,0,0.5);"></div>
              </div>
            </div>
            <div id="paymentQRDisplay" style="display: none; text-align: center; padding: 10px;">
              <div style="font-weight: bold; margin-bottom: 10px;">Scan to Pay</div>
              <div style="background: white; padding: 10px; display: inline-block;">
                <div style="width: 100px; height: 100px; background: repeating-linear-gradient(45deg, #182040, #182040 8px, #151c38 8px, #151c38 16px); display: grid; place-items: center;">
                  <span style="color: rgba(255,255,255,0.2); font-weight: bold;">QR</span>
                </div>
              </div>
              <div id="paymentAmount" style="margin-top: 10px; font-weight: bold;"></div>
            </div>
          </div>
          <div>
            <div class="row">
              <button class="btn" id="btnScan">📷 Scan QR</button>
              <input id="pairCode" type="text" maxlength="6" placeholder="Enter code e.g. SC1234" aria-label="Enter 6 digit pairing code" />
              <button class="btn primary" id="btnPair">Pair</button>
            </div>
            <p class="hint">Demo: use code <b>SC1234</b> or click Scan to simulate.</p>
          </div>
        </div>
      </div>

      <div class="divider"></div>
      <div class="status">
        <div class="stat"><h3>Trolley</h3><p id="statId">—</p></div>
        <div class="stat"><h3>Battery</h3><p id="statBattery">—</p></div>
        <button class="btn" id="btnBrands">Show Popular Brands</button>

      </div>
    </div>

    <div class="card">
      <h2 class="title">2) Plan your List</h2>
      <p class="subtitle">Add items and SmartCart will map the fastest path.</p>
      
      <!-- Language selector -->
      <select id="languageSelector" class="language-selector">
        <option value="en">English</option>
        <option value="hi">Hindi (हिन्दी)</option>
        <option value="ta">Tamil (தமிழ்)</option>
        <option value="te">Telugu (తెలుగు)</option>
        <option value="ml">Malayalam (മലയാളം)</option>
        <option value="kn">Kannada (ಕನ್ನಡ)</option>
        <option value="bn">Bengali (বাংলা)</option>
        <option value="mr">Marathi (मराठी)</option>
        <option value="gu">Gujarati (ગુજરાતી)</option>
        <option value="pa">Punjabi (ਪੰਜਾਬੀ)</option>
      </select>
      
      <div class="row">
        <input id="addItem" type="text" placeholder="Add item (e.g., Whole wheat bread)" />
        <button class="btn" id="btnAdd">Add</button>
      </div>
      <div class="list" id="list"></div>
      <p class="hint">Tip: click an item to remove it.</p>
    </div>

    <div class="card">
      <h2 class="title">3) Your Cart</h2>
      <div class="items" id="cartItems" aria-live="polite" aria-busy="false"></div>
      <div class="divider"></div>
      <div class="pay-row">
        <div class="total">Total: <span id="total">₹0.00</span></div>
        <button class="btn primary" id="btnPay" disabled>Pay Now</button>
      </div>
      <p class="hint">Payment tokens stored securely. Supports UPI / Card.</p>
    </div>
  </section>

  <section class="grid cols-2" style="margin-top:16px">
    <div class="card">
      <h2 class="title">Live Guidance</h2>
      <p class="subtitle">Turn‑by‑turn aisle navigation from your current position.</p>
      <div class="items" id="navFeed"></div>
    </div>
    <div class="card">
      <h2 class="title">Assistant</h2>
      <p class="subtitle">Ask SmartCart for alternatives, nutrition info, or offers.</p>
      <div class="items" id="aiFeed" style="min-height: 200px; max-height: 300px; padding: 10px; background: rgba(15, 20, 38, 0.7); border-radius: 12px;"></div>
      <div class="row" style="margin-top: 15px;">
        <input id="ask" type="text" placeholder="Ask e.g., Where is the milk? or How much does bread cost?" style="padding: 14px; font-size: 16px;" />
        <button class="btn" id="btnAsk" style="padding: 14px 20px; font-size: 16px;">Ask</button>
      </div>
      <div class="row" style="margin-top:10px;">
        <button class="btn" id="btnSpeak" style="flex: 1; padding: 14px; font-size: 16px;">🎤 Speak</button>
      </div>
    </div>
  </section>

  <footer>
    <p>© <span id="year"></span> SmartCart Labs • <a href="#">Privacy</a> • <a href="#">Terms</a></p>
  </footer>
</main>

<div class="toast" id="toast" role="status" aria-live="polite"></div>

<script>
// app.js
const state = {
  paired: false,
  trolleyId: null,
  battery: 100,
  cart: [],
  list: [],
  language: "en" // Default language
};

const el = id => document.getElementById(id);
const $cart = el('cartItems');
const $total = el('total');
const fmt = new Intl.NumberFormat('en-IN', { style: 'currency', currency: 'INR' });

// Set current year in footer
document.getElementById('year').textContent = new Date().getFullYear();

// Language mapping for speech recognition
const languageCodes = {
  "en": "en-US",
  "hi": "hi-IN",
  "ta": "ta-IN",
  "te": "te-IN",
  "ml": "ml-IN",
  "kn": "kn-IN",
  "bn": "bn-IN",
  "mr": "mr-IN",
  "gu": "gu-IN",
  "pa": "pa-IN"
};

function toast(msg) {
  const t = el('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 2000);
}

// --- Render Functions ---
function renderPair() {
  el('pairText').textContent = state.paired ? 'Connected' : 'Not connected';
  el('pairDot').classList.toggle('ok', state.paired);
  el('statId').textContent = state.trolleyId ? '#' + state.trolleyId : '—';
  el('statBattery').textContent = state.battery ? state.battery + '%' : '—';
  el('btnPay').disabled = !state.cart.length;
}

function renderList() {
  const wrap = el('list');
  wrap.innerHTML = '';
  state.list.forEach((txt, i) => {
    const b = document.createElement('button');
    b.className = 'chip';
    b.textContent = txt;
    b.title = 'Remove ' + txt;
    b.onclick = () => { state.list.splice(i, 1); onListChange(); };
    wrap.appendChild(b);
  });
}

function renderCart() {
  $cart.innerHTML = '';
  let sum = 0;
  state.cart.forEach((p, i) => {
    sum += p.price * p.qty;
    const row = document.createElement('div');
    row.className = 'item';
    row.innerHTML = `
      <div class="img" aria-hidden="true"></div>
      <div>
        <div style="font-weight:700">${p.name}</div>
        <div class="muted">${p.qty} × ${fmt.format(p.price)}</div>
      </div>
      <div>
        <div class="price">${fmt.format(p.price * p.qty)}</div>
        <div class="row" style="margin-top:6px">
          <button class="btn" aria-label="Decrease" onclick="updateQty(${i},-1)">−</button>
          <button class="btn" aria-label="Increase" onclick="updateQty(${i},1)">+</button>
        </div>
      </div>`;
    $cart.appendChild(row);
  });
  $total.textContent = fmt.format(sum);
  el('btnPay').disabled = !state.cart.length;
}

window.updateQty = (idx, d) => {
  state.cart[idx].qty += d;
  if (state.cart[idx].qty <= 0) state.cart.splice(idx, 1);
  renderCart();
}

function pushFeed(id, text) {
  const wrap = el(id);
  const div = document.createElement('div');
  
  // Apply different styles based on the content
  if (text.includes('🗣 You:')) {
    div.className = 'ai-feed-item user';
  } else if (text.includes('Processing your request')) {
    div.className = 'ai-feed-item processing';
  } else {
    div.className = 'ai-feed-item';
  }
  
  div.textContent = text;
  wrap.prepend(div);
}

// Calculate cart total
function calculateCartTotal() {
  return state.cart.reduce((sum, item) => sum + (item.price * item.qty), 0);
}

// --- Pairing ---
function pairWithCode(code) {
  // Accept any code for demo purposes, but still use the standard demo code
  const demoCode = 'SC1234';
  // In a real implementation, you would validate the actual scanned code
  // For now, we'll just proceed with pairing for any scan
  
  // Generate random trolley ID, e.g., SC + 4-digit number
  const randomId = 'SC' + Math.floor(1000 + Math.random() * 9000);
  state.paired = true;
  state.trolleyId = randomId;
  state.battery = 100;
  renderPair();
  toast('Paired to trolley #' + state.trolleyId);
  
  // Generate QR code for payment (will be called automatically after scanning)
}

// Generate QR code for payment
function generatePaymentQR() {
  const total = calculateCartTotal();
  const paymentData = {
    trolleyId: state.trolleyId,
    total: total,
    timestamp: new Date().toISOString()
  };
  
  // In a real implementation, this would generate an actual QR code
  // For demo purposes, we'll just show a placeholder with the amount
  const qrContainer = el('paymentQRDisplay');
  const amountDisplay = el('paymentAmount');
  amountDisplay.textContent = `Total: ${fmt.format(total)}`;
  qrContainer.style.display = 'block';
  
  // Show payment options automatically when QR is generated
  setTimeout(() => {
    showPaymentOptions();
  }, 2000);
}

// Simulate QR scanning
function simulateQRScan() {
  // In a real implementation, this would use the device's camera
  // For demo purposes, we'll simulate a successful scan
  const scannedCode = 'SC1234';
  pairWithCode(scannedCode);
}

// Start camera for QR scanning
function startCameraScan() {
  const video = el('qrVideo');
  const cameraContainer = el('cameraContainer');
  const qrContainer = el('qrCodeContainer');
  
  // Show camera container
  cameraContainer.style.display = 'block';
  qrContainer.style.background = 'transparent';
  
  // Access camera
  if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
    navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
      .then(function(stream) {
        video.srcObject = stream;
        video.play();
        
        // Start scanning for QR codes
        scanQRCode(video);
      })
      .catch(function(err) {
        console.error("Camera access error:", err);
        toast("Camera access denied or not available");
        stopCameraScan();
      });
  } else {
    toast("Camera not supported in this browser");
    stopCameraScan();
  }
}

// Stop camera scanning
function stopCameraScan() {
  const video = el('qrVideo');
  const cameraContainer = el('cameraContainer');
  const qrContainer = el('qrCodeContainer');
  
  // Stop video stream
  if (video.srcObject) {
    const tracks = video.srcObject.getTracks();
    tracks.forEach(track => track.stop());
  }
  
  // Hide camera container
  cameraContainer.style.display = 'none';
  qrContainer.style.background = 'repeating-linear-gradient(45deg, #182040, #182040 8px, #151c38 8px, #151c38 16px)';
}

// Simulate QR code scanning (in a real app, you would use a library like jsQR)
function scanQRCode(video) {
  // This is a simplified simulation
  // In a real implementation, you would use a library like jsQR to detect QR codes
  
  const scanInterval = setInterval(() => {
    // Simulate QR code detection - now works with any QR code
    // In a real app, this would process video frames to detect QR codes
    if (Math.random() > 0.95) { // 5% chance each interval to "find" a QR code
      // Instead of a fixed code, we'll simulate scanning any QR code
      const scannedCode = 'PRODUCT_QR_' + Math.floor(Math.random() * 10000);
      
      // Simulate delay for processing
      toast('Processing product QR code...');
      
      setTimeout(() => {
        // After scanning any QR code, pair with trolley
        pairWithCode('SC1234'); // Use the demo code for pairing
        
        // After pairing, generate payment with correct product price
        setTimeout(() => {
          // Clear existing cart
          state.cart = [];
          
          // Add scanned product to cart with correct price
          const products = [
            {name: "Apple iPhone 15", price: 799.99},
            {name: "Samsung Galaxy S24", price: 699.99},
            {name: "Sony WH-1000XM5 Headphones", price: 349.99},
            {name: "Apple MacBook Air M2", price: 1099.99},
            {name: "Nintendo Switch OLED", price: 349.99},
            {name: "Sony PlayStation 5", price: 499.99},
            {name: "Microsoft Surface Pro 9", price: 899.99},
            {name: "Apple iPad Pro", price: 799.99},
            {name: "Dyson V15 Detect Vacuum", price: 599.99},
            {name: "Instant Pot Duo 7-in-1", price: 89.99},
            {name: "Organic Bananas (1 lb)", price: 0.69},
            {name: "Whole Wheat Bread", price: 2.49},
            {name: "Farm Fresh Eggs (12 count)", price: 3.99},
            {name: "Almond Milk (1 gallon)", price: 3.79},
            {name: "Greek Yogurt (32 oz)", price: 5.99},
            {name: "Organic Spinach (16 oz)", price: 3.49},
            {name: "Grass-Fed Ground Beef (1 lb)", price: 8.99},
            {name: "Atlantic Salmon Fillet (1 lb)", price: 12.99},
            {name: "Organic Brown Rice (2 lbs)", price: 3.99},
            {name: "Extra Virgin Olive Oil (16 oz)", price: 9.99},
            {name: "Organic Coffee Beans (12 oz)", price: 14.99},
            {name: "Dark Chocolate (85%, 3.5 oz)", price: 2.99},
            {name: "Organic Quinoa (12 oz)", price: 4.99},
            {name: "Himalayan Pink Salt (26 oz)", price: 5.99},
            {name: "Coconut Water (11.2 oz, 12 pack)", price: 14.99},
            {name: "Organic Green Tea (20 count)", price: 4.49},
            {name: "Protein Powder (Vanilla, 2 lbs)", price: 29.99},
            {name: "Natural Peanut Butter (16 oz)", price: 4.99},
            {name: "Organic Tomato Sauce (24 oz)", price: 2.99},
            {name: "Gluten-Free Pasta (12 oz)", price: 2.49}
          ];
          
          // Select a random product
          const randomProduct = products[Math.floor(Math.random() * products.length)];
          const randomQty = Math.floor(Math.random() * 3) + 1;
          
          // Add to cart
          state.cart.push({
            name: randomProduct.name,
            price: randomProduct.price,
            qty: randomQty
          });
          
          renderCart();
          generatePaymentQR();
        }, 2000);
      }, 2500);
      
      stopCameraScan();
      clearInterval(scanInterval);
    }
  }, 500);
  
  // Stop scanning if camera is stopped
  video.addEventListener('pause', () => {
    clearInterval(scanInterval);
  });
}

// Process payment
function processPayment(paymentMethod, email = null) {
  const total = calculateCartTotal();
  
  if (total <= 0) {
    toast('Cart is empty!');
    return;
  }
  
  // Show payment processing message
  toast(`Processing ${paymentMethod} payment...`);
  
  // Simulate payment processing with different behaviors for different payment methods
  setTimeout(() => {
    // Send payment request to backend
    fetch('/api/checkout', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ 
        cart: state.cart,
        paymentMethod: paymentMethod,
        email: email
      })
    })
    .then(res => res.json())
    .then(data => {
      if (data.success) {
        // Different success messages based on payment method
        let successMessage = '';
        if (paymentMethod === 'UPI') {
          successMessage = 'UPI payment successful! ✔ Transaction ID: UPI' + Math.floor(100000 + Math.random() * 900000);
        } else if (paymentMethod === 'Card') {
          successMessage = 'Card payment successful! ✔ Transaction ID: CARD' + Math.floor(100000 + Math.random() * 900000);
        } else {
          successMessage = 'Payment successful! ✔';
        }
        
        toast(successMessage);
        state.cart = [];
        renderCart();
        
        // Show appropriate message based on email status
        let receiptMessage = data.email_status || `Payment successful. Total: ${fmt.format(data.total)}`;
        pushFeed('aiFeed', receiptMessage);
        
        // Hide QR code after payment
        const qrContainer = el('paymentQRDisplay');
        qrContainer.style.display = 'none';
      } else {
        toast('Payment failed: ' + (data.error || 'Unknown error'));
      }
    })
    .catch(err => {
      console.error('Payment error:', err);
      toast('Payment failed: Network error');
    });
  }, 1500);
}

// Show payment options
function showPaymentOptions() {
  const total = calculateCartTotal();
  if (total <= 0) {
    toast('Cart is empty!');
    return;
  }
  
  // Create payment modal
  const modal = document.createElement('div');
  modal.id = 'paymentModal';
  modal.style.cssText = `
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.7);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1000;
  `;
  
  modal.innerHTML = `
    <div class="card" style="width: 90%; max-width: 400px; padding: 20px;">
      <h2 class="title">Payment Options</h2>
      <p class="subtitle">Total: ${fmt.format(total)}</p>
      
      <div style="margin: 15px 0;">
        <label for="emailInput" style="display: block; margin-bottom: 5px; font-weight: 600;">Email for Receipt:</label>
        <input type="email" id="emailInput" placeholder="your@email.com" style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.2); background: #0f1426; color: var(--text);">
      </div>
      
      <div style="display: flex; flex-direction: column; gap: 15px; margin: 20px 0;">
        <button class="btn" id="btnPayUPI" style="padding: 15px; font-size: 16px;">
          💸 UPI Payment
        </button>
        <button class="btn" id="btnPayCard" style="padding: 15px; font-size: 16px;">
          💳 Credit/Debit Card
        </button>
      </div>
      
      <button class="btn" id="btnCancelPayment" style="width: 100%; padding: 12px;">
        Cancel
      </button>
    </div>
  `;
  
  document.body.appendChild(modal);
  
  // Add event listeners
  el('btnPayUPI').onclick = () => {
    const email = el('emailInput').value.trim();
    document.body.removeChild(modal);
    processPayment('UPI', email);
  };
  
  el('btnPayCard').onclick = () => {
    const email = el('emailInput').value.trim();
    document.body.removeChild(modal);
    processPayment('Card', email);
  };
  
  el('btnCancelPayment').onclick = () => {
    document.body.removeChild(modal);
  };
}

// --- Event Listeners ---
el('btnDisconnect').onclick = () => {
  state.paired = false;
  state.trolleyId = null;
  state.battery = 0;
  renderPair();
  toast('Disconnected from trolley');
  el('btnDisconnect').disabled = true;
  
  // Hide QR code when disconnected
  const qrContainer = el('paymentQRDisplay');
  qrContainer.style.display = 'none';
  stopCameraScan();
}

el('btnScan').onclick = () => startCameraScan();
el('btnPair').onclick = () => pairWithCode(el('pairCode').value.trim());

el('btnAdd').onclick = () => {
  const v = el('addItem').value.trim();
  if (!v) return;
  state.list.push(v);
  el('addItem').value = '';
  onListChange();
};

el('btnAsk').onclick = () => {
  const v = el('ask').value.trim();
  if (!v) return;
  
  // Send request with language preference
  fetch('/api/ask', {
    method: 'POST',
    headers: { 
      'Content-Type': 'application/json; charset=utf-8'
    },
    body: JSON.stringify({ 
      query: v,
      language: state.language
    })
  })
  .then(res => res.json())
  .then(data => {
    pushFeed('aiFeed', '🤖 ' + data.response);
    speak(data.response);
  })
  .catch(err => {
    // Generate random product responses
    const responses = [
      "That's an interesting question. I'd recommend checking aisle 3 for that item.",
      "I can help you find that product. It's probably near the back of the store.",
      "That item is on promotion this week. You should definitely check it out!",
      "I'm not sure about the exact location, but I can guide you to the right section.",
      "We have multiple options for that product. Would you like me to show you?",
      "That's a popular item! Many customers have been asking about it lately.",
      "I can check our inventory for you. It might be in the seasonal section.",
      "That product comes in different varieties. Which one would you prefer?",
      "I found similar items in aisle 5. Would you like me to direct you there?",
      "We just got a new shipment of those items. They're in the front of the store.",
      "That product is part of our premium collection. It's very high quality.",
      "I can help you compare prices for that item across different brands.",
      "Many customers love that product. It has excellent reviews.",
      "That item is flying off the shelves! We might need to reorder soon.",
      "I can check if we have that in stock. Would you like me to do that?",
      "That product is available in multiple sizes. Which would work best for you?",
      "We have both organic and conventional options for that item.",
      "That's a seasonal product. We only stock it at certain times of year.",
      "I can help you find alternatives if that specific item is out of stock.",
      "That item is part of our loyalty program rewards. Are you a member?",
      "We have a special display for that product near the entrance.",
      "That's a new item we just added. I can show you where it is.",
      "I can check our online inventory if we don't have it in-store.",
      "That product is eligible for our price match guarantee.",
      "We have a sample of that item available for you to try first.",
      "That's one of our best-selling products. Very popular with customers.",
      "I can help you find the best deal on that item right now.",
      "That product comes with a satisfaction guarantee.",
      "We have both regular and premium versions of that item.",
      "That's a limited edition product. We only have a few left.",
      "I can help you locate that item and also find complementary products."
    ];
    
    const randomResponse = responses[Math.floor(Math.random() * responses.length)];
    pushFeed('aiFeed', '🤖 ' + randomResponse);
    speak(randomResponse);
  });
  
  el('ask').value = '';
};

el('btnPay').onclick = () => {
  if (!state.paired) {
    toast('Please pair with trolley first!');
    return;
  }
  
  if (state.cart.length === 0) {
    toast('Cart is empty!');
    return;
  }
  
  generatePaymentQR();
};

el('btnHelp').onclick = () => {
  alert('Demo Instructions:\n\n' +
        '1. Pair with trolley: Click "Scan QR" to use camera or enter code SC1234\n' +
        '2. Add items to your shopping list\n' +
        '3. View cart items and total\n' +
        '4. Click "Pay Now" to initiate payment\n' +
        '5. Scan the QR code that appears\n' +
        '6. Choose UPI or Card payment method\n\n' +
        'Supported payment methods:\n' +
        '• UPI Payment\n' +
        '• Credit/Debit Card');
};

// Language selector change
el('languageSelector').onchange = (e) => {
  state.language = e.target.value;
  toast(`Language changed to ${e.target.options[e.target.selectedIndex].text}`);
};

// --- Voice Assistant ---
el('btnSpeak').onclick = () => {
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  if (!SpeechRecognition) { toast('Speech not supported'); return; }
  
  const recognition = new SpeechRecognition();
  // Set language for speech recognition
  recognition.lang = languageCodes[state.language] || "en-US";
  recognition.interimResults = false;
  recognition.onresult = event => {
    const query = event.results[0][0].transcript;
    pushFeed('aiFeed', '🗣 You: ' + query);
    handleVoiceQuery(query);
  };
  recognition.onerror = event => {
    console.error('Speech recognition error', event.error);
    toast('Voice recording error: ' + event.error);
  };
  recognition.onend = () => {
    toast('Voice recording ended');
  };
  try {
    recognition.start();
    toast('Listening in ' + state.language + '...');
  } catch (error) {
    console.error('Speech recognition error', error);
    toast('Voice recording error: ' + error.message);
  }
}

function handleVoiceQuery(text) {
  text = text.toLowerCase();
  
  // Show processing message
  pushFeed('aiFeed', '🤖 Processing your request...');
  
  // Send request to backend API for LLM processing
  fetch('/api/ask', {
    method: 'POST',
    headers: { 
      'Content-Type': 'application/json; charset=utf-8'
    },
    body: JSON.stringify({ 
      query: text,
      language: state.language
    })
  })
  .then(res => res.json())
  .then(data => {
    // Remove the processing message
    const feed = el('aiFeed');
    if (feed.firstChild && feed.firstChild.textContent.includes('Processing your request')) {
      feed.removeChild(feed.firstChild);
    }
    pushFeed('aiFeed', '🤖 ' + data.response);
    speak(data.response);
  })
  .catch(err => {
    console.error('Error processing voice query', err);
    // Remove the processing message
    const feed = el('aiFeed');
    if (feed.firstChild && feed.firstChild.textContent.includes('Processing your request')) {
      feed.removeChild(feed.firstChild);
    }
    // Generate random product responses
    const responses = [
      "That's an interesting question. I'd recommend checking aisle 3 for that item.",
      "I can help you find that product. It's probably near the back of the store.",
      "That item is on promotion this week. You should definitely check it out!",
      "I'm not sure about the exact location, but I can guide you to the right section.",
      "We have multiple options for that product. Would you like me to show you?",
      "That's a popular item! Many customers have been asking about it lately.",
      "I can check our inventory for you. It might be in the seasonal section.",
      "That product comes in different varieties. Which one would you prefer?",
      "I found similar items in aisle 5. Would you like me to direct you there?",
      "We just got a new shipment of those items. They're in the front of the store.",
      "That product is part of our premium collection. It's very high quality.",
      "I can help you compare prices for that item across different brands.",
      "Many customers love that product. It has excellent reviews.",
      "That item is flying off the shelves! We might need to reorder soon.",
      "I can check if we have that in stock. Would you like me to do that?",
      "That product is available in multiple sizes. Which would work best for you?",
      "We have both organic and conventional options for that item.",
      "That's a seasonal product. We only stock it at certain times of year.",
      "I can help you find alternatives if that specific item is out of stock.",
      "That item is part of our loyalty program rewards. Are you a member?",
      "We have a special display for that product near the entrance.",
      "That's a new item we just added. I can show you where it is.",
      "I can check our online inventory if we don't have it in-store.",
      "That product is eligible for our price match guarantee.",
      "We have a sample of that item available for you to try first.",
      "That's one of our best-selling products. Very popular with customers.",
      "I can help you find the best deal on that item right now.",
      "That product comes with a satisfaction guarantee.",
      "We have both regular and premium versions of that item.",
      "That's a limited edition product. We only have a few left.",
      "I can help you locate that item and also find complementary products."
    ];
    
    const randomResponse = responses[Math.floor(Math.random() * responses.length)];
    pushFeed('aiFeed', '🤖 ' + randomResponse);
    speak(randomResponse);
  });
}

function speak(text) {
  if ('speechSynthesis' in window) {
    window.speechSynthesis.cancel(); // cancel previous speech
    const msg = new SpeechSynthesisUtterance(text);
    
    // Set language for speech synthesis
    msg.lang = languageCodes[state.language] || "en-US";
    msg.rate = 1;
    window.speechSynthesis.speak(msg);
  }
}

// --- Navigation & Battery Simulation ---
const rows = 3, cols = 3;
const product_location = {
  "entrance": [0,0],
  "fruits": [0,1],
  "juice": [0,2],
  "maggi": [1,0],
  "milk": [1,1],
  "shampoo": [1,2],
  "ice cream": [2,0],
  "snacks": [2,1],
  "bakery": [2,2]
};
const moves = [[0,1,"right"], [0,-1,"left"], [1,0,"down"], [-1,0,"up"]];

function bfs(start, goal) {
  const queue = [[start, []]];
  const visited = new Set([start.toString()]);
  while (queue.length) {
    const [pos, path] = queue.shift();
    const [x, y] = pos;
    if (x === goal[0] && y === goal[1]) return path;
    for (const [dx, dy, dir] of moves) {
      const nx = x + dx, ny = y + dy;
      if (nx >= 0 && nx < rows && ny >= 0 && ny < cols && !visited.has([nx, ny].toString())) {
        queue.push([[nx, ny], path.concat(dir)]);
        visited.add([nx, ny].toString());
      }
    }
  }
  return [];
}

function updateGuidance() {
  if (!state.list.length) return;
  let currentPos = product_location["entrance"];
  const feed = el('navFeed');
  feed.innerHTML = '';
  for (let item of state.list) {
    const goal = product_location[item.toLowerCase()] || currentPos;
    const path = bfs(currentPos, goal);
    feed.innerHTML += `<div>Next item: ${item} → ${path.length ? "Path: " + path.join(" → ") : "Location unknown"}</div>`;
    currentPos = goal;
  }
}

function onListChange() {
  renderList();
  updateGuidance();
  if (state.list.length) {
    const next = state.list[0];
    const path = bfs(product_location["entrance"], product_location[next.toLowerCase()]);
    speak(`Next item: ${next}. Follow path: ${path.join(", ")}`);
  }
}

// Battery drain simulation
setInterval(() => {
  if (state.paired && state.battery > 5) {
    state.battery--;
    renderPair();
  }
}, 10000);

// Initial render
renderPair();
renderList();
renderCart();
</script>
</body>
</html>